#!/bin/bash
set -e -u -x

BASEDIR=$(pwd)
NUGET="mono ${BASEDIR}/nuget.exe"
PACKAGESDIR=${BASEDIR}/local-packages

if [ ! -f nuget.exe ]; then
	curl -o nuget.exe https://dist.nuget.org/win-x86-commandline/v4.9.4/nuget.exe
fi
${NUGET} >/dev/null

prepare_repo() {
	if [ -d "$1" ]; then
		pushd "$1"
		git fetch
		git clean -dfx
		git reset --hard
	else
		git clone "$2" "$1"
		pushd "$1"
	fi
	git checkout -f "$3"
	git submodule update --init --recursive
	popd
}

prepare_repo runtime https://github.com/dotnet/runtime 5c5e66e6c067f8a82d514598575011cd21655ffb
prepare_repo roslyn https://github.com/dotnet/roslyn 069a85a786acae3be2c7b49e330b7f968a624c88
prepare_repo sdk https://github.com/dotnet/sdk 097c9203c352def8e5fe6ad6b73ae7cef37b97da
prepare_repo aspnetcore https://github.com/dotnet/aspnetcore da6cdcbd5dc75b695cee36d47a22e1399cbea89e
prepare_repo installer https://github.com/dotnet/installer 693b8eb2cc0a177a3466864f8e65ad45037894c5

pushd runtime
git fetch https://github.com/iii-i/runtime.git 68266
git cherry-pick --allow-empty FETCH_HEAD
popd

pushd sdk
ln -fs ../sdk-patches patches
sed -e "s#@@PACKAGESDIR@@#${PACKAGESDIR}#" <patches/diff-sdk-hack-localrepo.in >patches/diff-sdk-hack-localrepo
quilt push -a
popd

pushd installer
ln -fs ../installer-patches patches
sed -e "s#@@PACKAGESDIR@@#${PACKAGESDIR}#" <patches/diff-installer-hack-localrepo.in >patches/diff-installer-hack-localrepo
quilt push -a
popd
