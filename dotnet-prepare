#!/bin/bash
set -e -u -x -o pipefail

filter=()
if git -C "$(dirname "$0")" fetch --filter=tree:0 >/dev/null 2>&1; then
    # shellcheck disable=SC2034
    clone_filter=(--filter=tree:0)
fi
function backport {
    local fixes=$1
    local commitids=$2

    if [ -n "$fixes" ] && git merge-base --is-ancestor "$fixes" HEAD; then
        return
    fi

    for commitid in $commitids; do
        # Skip if already applied
        if git merge-base --is-ancestor "$commitid" HEAD; then
            return
        fi
    done

    # Clean up any previous failed cherry-pick
    if [ -f .git/CHERRY_PICK_HEAD ]; then
        git cherry-pick --abort || true
    fi

    for commitid in $commitids; do
        git cherry-pick -X theirs "$commitid" --no-edit --no-commit
        break
    done
}

function prepare_sdk {
    pushd dotnet
    if [[ -s ../dotnet-patches/series ]] &&
        ! git merge-base --is-ancestor "49278fa" HEAD; then
        rm -rf .pc
        ln -fsT ../dotnet-patches patches
        quilt push -a
    else
        git fetch origin main
        backport "" e64f84d
    fi
    popd
}
projects=(dotnet)
git submodule update "${filter[@]}" --init --recursive -- "${projects[@]}"
eval prepare_sdk
